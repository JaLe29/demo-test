import e,{useState as t,useEffect as n,useCallback as r}from"react";import o,{gql as a}from"apollo-boost";import{ApolloProvider as u,useQuery as i,useMutation as m}from"@apollo/react-hooks";import c from"date-fns/formatDistanceToNow";function l(e,t,n,r,o,a,u){try{var i=e[a](u),m=i.value}catch(e){return void n(e)}i.done?t(m):Promise.resolve(m).then(r,o)}function d(){return(d=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function s(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function f(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],r=!0,o=!1,a=void 0;try{for(var u,i=e[Symbol.iterator]();!(r=(u=i.next()).done)&&(n.push(u.value),!t||n.length!==t);r=!0);}catch(e){o=!0,a=e}finally{try{r||null==i.return||i.return()}finally{if(o)throw a}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function p(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function _(e,t){void 0===t&&(t={});var n=t.insertAt;if(e&&"undefined"!=typeof document){var r=document.head||document.getElementsByTagName("head")[0],o=document.createElement("style");o.type="text/css","top"===n&&r.firstChild?r.insertBefore(o,r.firstChild):r.appendChild(o),o.styleSheet?o.styleSheet.cssText=e:o.appendChild(document.createTextNode(e))}}var h="textArea-module_textArea__jOs0v",v="textArea-module_normal__252TE",x="textArea-module_notFocused__39uMv";_(".textArea-module_textArea__jOs0v {\n  border-radius: 5px;\n  width: calc(100% - 20px - 10px - 2px);\n  padding: 10px;\n  margin: 5px;\n  border: 1.5px solid;\n  resize: none;\n  font-family: inherit;\n  font-size: inherit; }\n  .textArea-module_textArea__jOs0v:focus {\n    outline: none; }\n\n.textArea-module_message__356sA {\n  height: 70px;\n  width: 100%; }\n\n.textArea-module_normal__252TE {\n  border-color: #288ce4; }\n\n.textArea-module_notFocused__39uMv {\n  color: #b7b7b7 !important;\n  border-color: #b7b7b7 !important; }\n\n.textArea-module_error__3cOzU {\n  border-color: red !important; }\n");var g=e.memo((function(r){var o=r.onSubmit,a=r.setInputState,u=r.inputState,i=f(t(!1),2),m=i[0],c=i[1],l=f(t(""),2),d=l[0],s=l[1],p=!1;n((function(){var e;return"done"===u&&(e=setTimeout((function(){c(!1),a("ready")}),2e3)),function(){e&&clearTimeout(e)}}),[u,a]);var _=function(e){if(13===e.keyCode&&!1===e.shiftKey){p=!0;var t=d.trim();if(0===t.length)return;return o(t),void s("")}if(p)p=!1;else{var n=e.target.value||"";s(n)}},g=[h];return m?g.push(v):g.push(x),["sending","done"].includes(u)?"DONE":e.createElement("textarea",{value:d,onChange:_,onKeyDown:_,onFocus:function(){return c(!0)},onBlur:function(){return c(!1)},className:g.join(" "),placeholder:"Join the discussion..."})})),y="comment-module_comment__1VBGu",b="comment-module_headerWrapper__2zqKy",A="comment-module_profilePhoto__1OoMA",w="comment-module_name__1-F6F",E="comment-module_date__2-IUq",O="comment-module_text__1W5B4";_(".comment-module_comment__1VBGu {\n  display: flex;\n  padding: 5px; }\n  .comment-module_comment__1VBGu .comment-module_headerWrapper__2zqKy {\n    display: flex; }\n  .comment-module_comment__1VBGu .comment-module_profilePhoto__1OoMA {\n    height: 35px;\n    width: 35px;\n    border-radius: 5px;\n    margin-right: 5px; }\n  .comment-module_comment__1VBGu .comment-module_name__1-F6F {\n    color: #288ce4;\n    font-size: 10px;\n    font-weight: bold; }\n  .comment-module_comment__1VBGu .comment-module_date__2-IUq {\n    font-size: 10px;\n    padding-left: 5px; }\n  .comment-module_comment__1VBGu .comment-module_text__1W5B4 {\n    margin: 0px;\n    white-space: pre-wrap;\n    overflow-wrap: break-word; }\n");var S=function(t){var n=t.text,o=t.user,a=t.createdAt,u=t.users,i=r((function(){return c(new Date(a),{addSuffix:!0})}),[a]);return e.createElement("div",{className:y},u[o]&&u[o].image&&e.createElement("img",{className:A,src:u[o].image,alt:u[o].name}),e.createElement("div",null,e.createElement("div",{className:b},e.createElement("div",{className:w},u[o]?u[o].name:"Unknown user"),e.createElement("div",{className:E},i())),e.createElement("p",{className:O},n)))};function j(){var e=s(["\n  mutation createComment($text: String!, $code: String!, $user: String) {\n    createComment(data: { text: $text, code: $code, user: $user }) {\n      id\n      text\n      createdAt\n      user\n    }\n  }\n"]);return j=function(){return e},e}function C(){var e=s(["\n  query getComments($code: String!) {\n    getComments(where: { code: $code }) {\n      id\n      text\n      createdAt\n      user\n    }\n  }\n"]);return C=function(){return e},e}var B=new o({uri:"http://localhost:8080/graphql"}),N=a(C()),z=a(j()),T=function(n){var o=n.code,a=n.authKey,u=n.users,c=n.user,s=f(t([]),2),_=s[0],h=s[1],v=i(N,{variables:{code:o},context:{headers:{authorization:a}}}),x=v.loading,y=v.data,b=f(m(z),1)[0],A=f(t("ready"),2),w=A[0],E=A[1],O=r(function(){var e,t=(e=regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return E("sending"),e.next=3,b({variables:{text:t,code:o,user:c},context:{headers:{authorization:a}}});case 3:n=e.sent,r=n.data.createComment,h([r].concat(p(_))),E("done");case 7:case"end":return e.stop()}}),e)})),function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function u(e){l(a,r,o,u,i,"next",e)}function i(e){l(a,r,o,u,i,"throw",e)}u(void 0)}))});return function(e){return t.apply(this,arguments)}}(),[b,a,_,o]);return e.createElement("div",null,e.createElement(g,{onSubmit:O,inputState:w,setInputState:E}),x?"LOADING":e.createElement(e.Fragment,null,0===_.length&&0===y.getComments.length?"EMPTY":e.createElement(e.Fragment,null,_.map((function(t){return e.createElement(S,d({key:t.id},t,{users:u}))})),y.getComments.map((function(t){return e.createElement(S,d({key:t.id},t,{users:u}))})))))};export default function(t){var n=t.code,r=t.authKey,o=t.users,a=t.user;return e.createElement(u,{client:B},e.createElement(T,{code:n,authKey:r,users:o,user:a}))}
